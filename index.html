<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Chord Generator & Metronome</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1b. Load External Libraries -->
    <!-- Montserrat font (Bold and modern) -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- html2canvas library for image download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Lucide icons for resource links -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 2. Configure Tailwind and add Montserrat font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        'primary-teal': '#2dd4bf', // teal-400
                        'secondary-pink': '#ec4899', // pink-500
                        'accent-yellow': '#fcd34d', // amber-300
                    }
                },
            },
        };
    </script>
    
    <!-- 3. Custom CSS for the piano keys and metronome -->
    <style>
        body {
            font-family: 'Montserrat', 'sans-serif';
        }

        /* White key styles */
        .key.white {
            width: 3.5rem; 
            height: 16rem;
            background-color: white;
            border: 2px solid #374151; /* gray-700 */
            border-top: 0;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background-color 0.1s, transform 0.05s;
            cursor: pointer;
            z-index: 5;
        }
        
        /* White key pressed state */
        .key.white.pressed {
            transform: translateY(2px);
            background-color: #f3f4f6; /* Lighter pressed state */
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        /* All keys are relative for label positioning */
        .key {
            position: relative;
        }

        /* Black key styles */
        .key.black {
            width: 2rem; 
            height: 10rem;
            background-color: #1a202c; 
            border: 2px solid #111827; 
            border-bottom-width: 4px;
            border-radius: 0 0 6px 6px;
            position: absolute;
            top: 0;
            right: -1rem; 
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.7);
            transition: background-color 0.1s, transform 0.05s;
            cursor: pointer;
        }
        
        /* Black key pressed state */
        .key.black.pressed {
            transform: translateY(1px);
            background-color: #0c0f13; /* Darker pressed state */
            box-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }

        /* No black key on E or B */
        .key.white[data-note="E"] > .key.black,
        .key.white[data-note="B"] > .key.black {
            display: none;
        }

        /* Highlight style for any key */
        .key.highlighted {
            background-color: #2dd4bf; /* primary-teal */
            border-color: #0d9488; /* teal-600 */
        }
        
        /* Specific highlight for black keys to override */
        .key.black.highlighted {
            background-color: #0d9488; /* Darker teal for contrast */
            border-color: #064e3b; /* even darker teal */
            box-shadow: 0 0 15px 3px #2dd4bf;
        }

        /* Key label styles */
        .key-label {
            position: absolute;
            font-weight: 700;
            pointer-events: none;
            font-size: 1.125rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        }

        .white-label {
            bottom: 1rem;
            left: 0;
            right: 0;
            text-align: center;
            color: #4b5563; /* gray-600 */
        }

        .black-label {
            bottom: 0.75rem;
            left: 0;
            right: 0;
            text-align: center;
            color: #d1d5db; /* gray-300 */
            font-size: 1rem;
        }

        /* Highlighted label colors */
        .key.highlighted .white-label {
            color: #0d9488; 
            font-weight: 800;
            text-shadow: none;
        }

        .key.black.highlighted .black-label {
            color: #f0fdfa;
            font-weight: 800;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        /* Metronome Indicator Styles */
        #metronome-indicator {
            transition: all 0.05s ease-out; /* Faster, smoother transition */
        }
        .metronome-active {
            background-color: #fcd34d !important; /* accent-yellow */
            box-shadow: 0 0 10px #fcd34d, 0 0 20px rgba(252, 211, 77, 0.5) !important;
            transform: scale(1.1); /* Subtle pulse */
        }
        
        /* Ensure the prose styles for the generated resource are applied */
        #resource-content .prose {
            max-width: 100%;
        }
        
        #resource-content .prose h3 {
            color: #fcd34d; /* yellow headings */
            border-bottom: 1px solid #4b5563;
            padding-bottom: 0.5rem;
        }
        #resource-content .prose p, #resource-content .prose ul {
            color: #d1d5db; /* light gray text */
        }

        /* Animations for dot pulse (color updated) */
        .dot-pulse {
            position: relative;
            left: -9999px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #fcd34d; /* accent-yellow */
            color: #fcd34d;
            box-shadow: 9999px 0 0 0 #fcd34d;
            animation: dotPulse 1.5s infinite linear;
        }
        
        @keyframes dotPulse {
            0% { box-shadow: 9999px 0 0 0 #fcd34d; }
            30% { box-shadow: 9999px 0 0 0 #fcd34d; }
            30.1% { box-shadow: 9999px 0 0 0 #fcd34d; }
            50% { box-shadow: 10009px 0 0 0 #fcd34d; }
            70% { box-shadow: 9999px 0 0 0 #fcd34d; }
            90% { box-shadow: 9999px 0 0 0 #fcd34d; }
            100% { box-shadow: 9999px 0 0 0 #fcd34d; }
        }

        /* Full screen overlay for access gate */
        #access-gate, #app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.95); /* Dark gray background */
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #access-gate-card {
            background-color: #1f2937;
            border: 2px solid #2dd4bf;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center">

    <!-- ACCESS GATE OVERLAY (Visible first) -->
    <div id="access-gate">
        <div id="access-gate-card" class="rounded-xl p-8 text-center">
            <i data-lucide="key" class="w-12 h-12 text-primary-teal mx-auto mb-4"></i>
            <h2 class="text-3xl font-bold text-white mb-2">Private Access</h2>
            <p class="text-gray-400 mb-6">Enter the secret key to unlock the music tools. The key is **Maestro2025**.</p>
            
            <input type="password" id="access-key-input" placeholder="Enter key..." class="w-full bg-gray-700 border-2 border-gray-600 text-white text-lg rounded-lg focus:ring-secondary-pink focus:border-secondary-pink p-3 shadow-inner mb-4">
            
            <button id="unlock-btn" class="w-full bg-secondary-pink hover:bg-pink-600 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.01] shadow-lg">
                Unlock Access
            </button>
            
            <p id="access-message" class="text-red-400 mt-4 h-6"></p>
        </div>
    </div>

    <!-- APP LOADING/AUTHENTICATING STATE (Hidden until key is correct) -->
    <div id="app-loading" class="hidden flex-col items-center justify-center h-96 bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-gray-700">
        <div class="dot-pulse mb-4 !bg-primary-teal !text-primary-teal"></div>
        <p class="text-xl text-primary-teal font-semibold">Authenticating User...</p>
    </div>

    <div class="max-w-7xl w-full">
        
        <!-- Main Content (Hidden until authenticated) -->
        <div id="authenticated-content" class="hidden">
            
            <header class="mb-6 bg-gray-800 rounded-xl shadow-inner p-4 flex flex-col md:flex-row items-center justify-between border-b border-primary-teal/50">
                <div class="text-center md:text-left mb-2 md:mb-0">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-white">Mobile Music Tools</h1>
                    <p id="user-status" class="text-sm text-gray-400 mt-1">Status: Loading...</p>
                </div>
                
                <button id="sign-out-btn" class="bg-gray-600 hover:bg-red-500 text-white font-bold text-sm py-2 px-4 rounded-lg transition-colors duration-200 shadow-md flex items-center" style="display: none;">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                    Sign Out
                </button>
            </header>
            
            <main class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-gray-700">
                
                <!-- NAVIGATION DROP DOWN -->
                <div class="flex justify-center mb-8">
                    <select id="view-selector" class="w-full max-w-md bg-gray-700 border-2 border-primary-teal text-white text-xl rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-lg font-bold transition-colors">
                        <option value="chord-view">🎹 Piano Chord Diagram</option>
                        <option value="songs-view">🎶 Simple Songs</option>
                        <option value="metronome-view">⏰ Metronome</option>
                        <option value="resources-view">📚 Resources & Tools</option>
                    </select>
                </div>

                ---
                
                <!-- 1. CHORD DIAGRAM GENERATOR VIEW -->
                <section id="chord-view">
                    <h2 class="text-3xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Chord Generation</h2>
                    
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        
                        <!-- Root Note Selector -->
                        <div>
                            <label for="root-note" class="block text-sm font-medium text-gray-400 mb-1">Root Note</label>
                            <select id="root-note" class="w-full md:w-48 bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-md">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>

                        <!-- Chord Type Selector -->
                        <div>
                            <label for="chord-type" class="block text-sm font-medium text-gray-400 mb-1">Chord Type</label>
                            <select id="chord-type" class="w-full md:w-64 bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-md">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>

                        <!-- Inversion Selector -->
                        <div>
                            <label for="inversion" class="block text-sm font-medium text-gray-400 mb-1">Inversion</label>
                            <select id="inversion" class="w-full md:w-40 bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-md">
                                <option value="0">Root Position</option>
                            </select>
                        </div>

                        <!-- Base Octave Selector (UPDATED DEFAULT) -->
                        <div>
                            <label for="base-octave" class="block text-sm font-medium text-gray-400 mb-1">Base Octave</label>
                            <select id="base-octave" class="w-full md:w-40 bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-md">
                                <option value="3">Octave 3 (C3)</option>
                                <option value="4" selected>Octave 4 (C4)</option> <!-- DEFAULT SET TO OCTAVE 4 -->
                                <option value="5">Octave 5 (C5)</option>
                            </select>
                        </div>

                        <!-- Play Mode Selector -->
                        <div>
                            <label for="play-mode" class="block text-sm font-medium text-gray-400 mb-1">Play Mode</label>
                            <select id="play-mode" class="w-full md:w-48 bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-primary-teal focus:border-primary-teal p-3 shadow-md">
                                <option value="simultaneous">Simultaneous</option>
                                <option value="arpeggiated">Arpeggiated</option>
                            </select>
                        </div>

                        <!-- Accidental Toggle -->
                        <div class="md:self-end">
                            <label for="accidental-toggle" class="block text-sm font-medium text-gray-400 mb-1">Accidentals</label>
                            <div class="flex bg-gray-700 border border-gray-600 rounded-lg overflow-hidden shadow-md">
                                <button id="sharps-btn" class="w-1/2 p-3 text-lg font-bold bg-primary-teal text-gray-900 transition-colors duration-200"># Sharps</button>
                                <button id="flats-btn" class="w-1/2 p-3 text-lg font-bold hover:bg-primary-teal/50 text-white transition-colors duration-200">b Flats</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chord Action Buttons -->
                    <div class="flex justify-center gap-4 mb-8 flex-wrap">
                        <!-- Play Button -->
                        <button id="play-btn" class="flex-1 max-w-[12rem] bg-secondary-pink hover:bg-pink-600 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                            Play Chord
                        </button>
                        <!-- Stop Chord Button -->
                        <button id="stop-btn" class="flex-1 max-w-[12rem] bg-gray-600 hover:bg-gray-500 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                            Stop Chord
                        </button>
                        <!-- Download Button -->
                        <button id="download-btn" class="flex-1 max-w-[12rem] bg-primary-teal hover:bg-teal-600 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                            Download Image
                        </button>
                    </div>

                    <!-- Chord Info Display -->
                    <div id="chord-info" class="text-center mb-10 h-16">
                        <h2 id="chord-name" class="text-3xl font-extrabold text-white">C Major</h2>
                        <p id="chord-notes" class="text-xl text-primary-teal">C4 - E4 - G4</p>
                    </div>

                    <!-- Piano Keyboard (Wider and horizontally scrollable) -->
                    <div class="flex justify-center overflow-x-scroll p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
                        <div id="piano-keyboard" data-name="Piano-Diagram" class="relative flex flex-nowrap min-w-full">
                            <!-- Piano keys will be generated by JS -->
                        </div>
                    </div>
                </section>

                
                ---
                <!-- 2. METRONOME VIEW -->
                <section id="metronome-view" style="display: none;">
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">Metronome</h2>
                    <div class="flex flex-col lg:flex-row items-center justify-center gap-6 mb-8 p-6 bg-gray-700 rounded-xl shadow-lg flex-wrap">
                        
                        <!-- BPM Control -->
                        <div class="flex flex-col items-center gap-3 w-full sm:w-auto">
                            <label for="bpm-input-metro" class="text-lg font-medium text-gray-300 whitespace-nowrap">Tempo (BPM):</label>
                            <div class="flex items-center gap-4 w-full justify-center">
                                <input type="number" id="bpm-input-metro" min="40" max="240" value="120" class="w-20 bg-gray-800 border border-gray-600 text-white text-lg rounded-lg focus:ring-accent-yellow focus:border-accent-yellow p-2 text-center shadow-inner">
                                <input type="range" id="bpm-slider-metro" min="40" max="240" value="120" class="w-32 md:w-48 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg">
                            </div>
                        </div>

                        <!-- Metronome Tone Selector -->
                        <div class="w-full sm:w-40">
                            <label for="metro-tone-select" class="block text-sm font-medium text-gray-400 mb-1 text-center sm:text-left">Click Tone</label>
                            <select id="metro-tone-select" class="w-full bg-gray-800 border border-gray-600 text-white text-lg rounded-lg focus:ring-accent-yellow focus:border-accent-yellow p-2 shadow-inner">
                                <option value="sine" selected>Sine (Soft)</option>
                                <option value="triangle">Triangle (Medium)</option>
                                <option value="square">Square (Sharp)</option>
                                <option value="sawtooth">Sawtooth (Buzzing)</option>
                                <option value="membrane">Membrane (Drum)</option>
                            </select>
                        </div>
                        
                        <!-- Metronome Indicator -->
                        <div class="w-12 h-12 rounded-full bg-gray-500 shadow-xl mt-4 lg:mt-0 border-2 border-gray-400" id="metronome-indicator"></div>

                        <!-- Metronome Buttons -->
                        <div class="flex gap-4 w-full sm:w-auto mt-4 lg:mt-0">
                            <button id="metro-start-btn" class="bg-accent-yellow hover:bg-yellow-600 text-gray-900 font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex-1 shadow-lg">
                                Start
                            </button>
                            <button id="metro-stop-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex-1 shadow-lg" disabled>
                                Stop
                            </button>
                        </div>
                    </div>
                </section>
                
                
                ---
                <!-- 3. SIMPLE SONGS VIEW -->
                <section id="songs-view" style="display: none;">
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">Simple Song Chord Progressions</h2>
                    
                    <p class="text-gray-300 mb-6">These popular songs use easy, repetitive chord sequences. Click any **chord chip** to instantly see and play that chord on the diagram page!</p>
                    
                    <div id="songs-list" class="space-y-6">
                        <!-- Songs will be rendered here by JS -->
                    </div>
                </section>
                
                
                ---
                <!-- 4. DYNAMIC RESOURCES VIEW -->
                <section id="resources-view" style="display: none;">
                    <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-2">Dynamic Learning Resources</h2>
                    
                    <p class="text-gray-300 mb-6">Ask me anything about music theory, technique, or history, and I will generate a comprehensive resource for you, grounded in up-to-date information.</p>
                    
                    <!-- Query Input and Button -->
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <input type="text" id="resource-query-input" placeholder="e.g., What is the I-IV-V chord progression?" class="flex-grow bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-secondary-pink focus:border-secondary-pink p-3 shadow-inner">
                        <button id="resource-generate-btn" class="w-full sm:w-48 bg-secondary-pink hover:bg-pink-600 text-white font-bold text-lg p-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg">
                            Generate Resource
                        </button>
                    </div>
                    
                    <!-- Resource Output Area (relative positioning for custom alert) -->
                    <div id="resource-output-card" class="bg-gray-700 p-6 rounded-xl shadow-inner border-l-4 border-primary-teal min-h-[150px] flex items-center justify-center relative">
                        <p class="text-gray-400 italic" id="initial-message">
                            The generated resource will appear here. Try asking a question above!
                        </p>
                        
                        <!-- Loading Indicator (Hidden by default) -->
                        <div id="resource-loading" class="hidden flex-col items-center p-4">
                            <div class="dot-pulse mb-3"></div>
                            <p class="text-accent-yellow font-semibold">Generating your custom resource...</p>
                        </div>
                        
                        <!-- Dynamic Content -->
                        <div id="resource-content" class="hidden w-full">
                            <!-- Content, sources, and links will be populated here -->
                        </div>
                    </div>
                </section>

            </main>
        </div>
        
        <!-- Copyright Footer with Title Case -->
        <footer class="text-center mt-6 mb-4 text-sm text-gray-500">
            &copy; 2024 **All Rights Reserved To Elliot's Mobile Music**.
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL FIREBASE/APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- SECRET ACCESS KEY ---
        const SECRET_ACCESS_KEY = "Maestro2025"; 

        let app = null;
        let db = null;
        let auth = null;
        let userId = null; 
        
        // --- 1. DATA DEFINITIONS ---
        
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const SHARP_TO_FLAT = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
        const FLAT_TO_SHARP = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' }; 
        
        const CHORD_FORMULAS = {
            'Major': [0, 4, 7], 'Minor': [0, 3, 7], 'Diminished': [0, 3, 6], 'Augmented': [0, 4, 8],
            'Suspended 2 (sus2)': [0, 2, 7], 'Suspended 4 (sus4)': [0, 5, 7], 'Major 7th (Maj7)': [0, 4, 7, 11],
            'Minor 7th (m7)': [0, 3, 7, 10], 'Dominant 7th (7)': [0, 4, 7, 10], 'Diminished 7th (dim7)': [0, 3, 6, 9],
            'Half-Diminished (m7b5)': [0, 3, 6, 10], 'Major 6th (6)': [0, 4, 7, 9], 'Minor 6th (m6)': [0, 3, 7, 9],
            'Add 9 (add9)': [0, 4, 7, 14], 'Major 9th (Maj9)': [0, 4, 7, 11, 14], 'Minor 9th (m9)': [0, 3, 7, 10, 14],
            'Dominant 9th (9)': [0, 4, 7, 10, 14], '7 Suspended 4 (7sus4)': [0, 5, 7, 10], 
            'Dominant 11th (11)': [0, 4, 7, 10, 14, 17], 'Major 11th (Maj11)': [0, 4, 7, 11, 14, 17],
            'Minor 11th (m11)': [0, 3, 7, 10, 14, 17], 'Dominant 13th (13)': [0, 4, 7, 10, 14, 17, 21],
        };
        const WHITE_NOTES_OCTAVE = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const NUM_OCTAVES = 3; 
        const START_OCTAVE = 3; 
        
        // API Setup
        const API_KEY = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const SYSTEM_PROMPT = "You are a highly experienced and friendly music theory tutor. Your task is to provide a concise, single-paragraph explanation of the user's music query, followed by a detailed, structured section (use bullet points or lists) that provides specific, actionable practice advice and examples. The goal is to provide a comprehensive, grounded resource for the musician. Do not use external links in the generated text content. Base your answer solely on the information you find.";

        const SIMPLE_SONGS = [
            { title: "Let It Be", artist: "The Beatles", key: "C Major", progression: ["C Major", "G Major", "A Minor", "F Major"] },
            { title: "Don't Stop Believin'", artist: "Journey", key: "E Major", progression: ["E Major", "B Major", "C# Minor", "A Major"] },
            { title: "Three Little Birds", artist: "Bob Marley", key: "A Major", progression: ["A Major", "D Major", "E Major"] },
            { title: "No Woman, No Cry", artist: "Bob Marley", key: "C Major", progression: ["C Major", "G Major", "A Minor", "F Major"] },
            { title: "Hallelujah", artist: "Leonard Cohen", key: "C Major", progression: ["C Major", "G Major", "A Minor", "F Major"] },
            { title: "With or Without You", artist: "U2", key: "D Major", progression: ["D Major", "A Major", "B Minor", "G Major"] },
            { title: "Sweet Caroline", artist: "Neil Diamond", key: "D Major", progression: ["D Major", "G Major", "A Major", "D Major"] },
            { title: "Imagine", artist: "John Lennon", key: "C Major", progression: ["C Major", "F Major", "G Major", "C Major"] },
            { title: "Someone Like You", artist: "Adele", key: "A Major", progression: ["A Major", "E Major", "F# Minor", "D Major"] },
            { title: "Heartbreak Hotel", artist: "Elvis Presley", key: "E Minor", progression: ["E Minor", "C Major", "G Major", "D Major"] }
        ];


        // --- 2. STATE & TONE.JS SETUP ---
        let useSharps = true;
        let synth = null; 
        let metronomeSynth = null; 
        let membraneSynth = null; 
        let arpeggiator = null; 
        let metronomeLoop = null; 
        let currentMetroTone = 'sine'; 
        let audioContextReady = false;

        function initTone() {
            try {
                if (!audioContextReady) {
                    if (Tone.Transport.state === 'started') {
                            Tone.Transport.stop();
                    }
                    Tone.Transport.clear(0);
                    
                    const reverb = new Tone.Reverb({
                        decay: 2.5, 
                        preDelay: 0.01
                    }).toDestination();

                    synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "sine" }, 
                        envelope: { 
                            attack: 0.005, decay: 0.6, sustain: 0.3, release: 1.8   
                        }
                    }).connect(reverb); 
                    
                    metronomeSynth = new Tone.Synth({
                        oscillator: { type: currentMetroTone }, 
                        envelope: {
                            attack: 0.001, decay: 0.1, sustain: 0, release: 0.1,
                        }
                    }).toDestination();
                    
                    membraneSynth = new Tone.MembraneSynth({
                        pitchDecay: 0.008,
                        octaves: 2,
                        envelope: {
                            attack: 0.001, decay: 0.1, sustain: 0,
                        }
                    }).toDestination();

                    Tone.Transport.bpm.value = 120;
                    audioContextReady = true;
                }
            } catch (e) {
                console.error("Tone.js initialization failed.", e);
            }
        }


        // --- 3. DOM ELEMENT REFERENCES ---
        // Access Gate
        const accessGateEl = document.getElementById('access-gate');
        const accessKeyInput = document.getElementById('access-key-input');
        const unlockBtn = document.getElementById('unlock-btn');
        const accessMessageEl = document.getElementById('access-message');

        // Auth/Gating
        const appLoadingEl = document.getElementById('app-loading');
        const authenticatedContentEl = document.getElementById('authenticated-content');
        const userStatusEl = document.getElementById('user-status');
        const signOutBtn = document.getElementById('sign-out-btn');

        // Navigation
        const viewSelector = document.getElementById('view-selector');
        const chordView = document.getElementById('chord-view');
        const metronomeView = document.getElementById('metronome-view');
        const resourcesView = document.getElementById('resources-view'); 
        const songsView = document.getElementById('songs-view');
        
        // Chord Elements
        const rootSelect = document.getElementById('root-note');
        const typeSelect = document.getElementById('chord-type');
        const inversionSelect = document.getElementById('inversion');
        const baseOctaveSelect = document.getElementById('base-octave');
        const playModeSelect = document.getElementById('play-mode');
        const chordNameEl = document.getElementById('chord-name');
        const chordNotesEl = document.getElementById('chord-notes');
        const pianoContainer = document.getElementById('piano-keyboard');
        const downloadBtn = document.getElementById('download-btn');
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const sharpsBtn = document.getElementById('sharps-btn');
        const flatsBtn = document.getElementById('flats-btn');
        
        // Metronome Elements
        const bpmInput = document.getElementById('bpm-input-metro');
        const bpmSlider = document.getElementById('bpm-slider-metro');
        const metroStartBtn = document.getElementById('metro-start-btn');
        const metroStopBtn = document.getElementById('metro-stop-btn');
        const metronomeIndicator = document.getElementById('metronome-indicator');
        const metroToneSelect = document.getElementById('metro-tone-select'); 
        
        // Resource Elements
        const resourceQueryInput = document.getElementById('resource-query-input');
        const resourceGenerateBtn = document.getElementById('resource-generate-btn');
        const initialMessageEl = document.getElementById('initial-message');
        const resourceLoadingEl = document.getElementById('resource-loading');
        const resourceContentEl = document.getElementById('resource-content');
        
        // Song Elements
        const songsListEl = document.getElementById('songs-list');


        // --- 4. CORE UTILITIES & VIEWS LOGIC ---

        function switchView(viewId) {
            if (Tone.context.state !== 'running') { Tone.start(); }

            if (viewId !== 'metronome-view') {
                stopMetronome();
            }
            stopChord();

            chordView.style.display = 'none';
            metronomeView.style.display = 'none';
            resourcesView.style.display = 'none'; 
            songsView.style.display = 'none';

            document.getElementById(viewId).style.display = 'block';
        }

        function getDisplayName(note) {
            if (useSharps) {
                return note;
            }
            return SHARP_TO_FLAT[note] || note;
        }
        
        function alertUser(message, isError = false) {
            // Use the dedicated message element on the access gate
            const targetEl = accessMessageEl;

            targetEl.textContent = message;
            targetEl.className = isError ? 'text-red-400 mt-4 h-6' : 'text-primary-teal mt-4 h-6';
            
            setTimeout(() => {
                targetEl.textContent = '';
            }, 5000); // Increased timeout for error messages
        }
        
        // --- CORE UTILITIES, METRONOME, AND RESOURCE LOGIC ---

        // Utility for fetching with exponential backoff (for Gemini API calls)
        async function backoffFetch(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            console.warn(`Request failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        } else {
                            throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                        }
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        throw new Error(`Fetch failed after ${retries} attempts: ${error.message}`);
                    }
                    console.warn(`Fetch attempt failed: ${error.message}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }


        // --- METRONOME IMPLEMENTATION ---
        
        function updateBPM(bpmValue) {
            const bpm = parseInt(bpmValue, 10);
            if (isNaN(bpm) || bpm < 40 || bpm > 240) return;
            
            bpmInput.value = bpm;
            bpmSlider.value = bpm;
            Tone.Transport.bpm.value = bpm;
        }

        function setMetronomeTone(tone) {
            currentMetroTone = tone;
            if (metronomeSynth) {
                if (currentMetroTone === 'membrane') {
                    // Use a separate synth for the drum sound
                    metronomeSynth.disconnect();
                    if (membraneSynth) membraneSynth.toDestination();
                } else {
                    // Use the main synth for pitched tones
                    metronomeSynth.oscillator.type = currentMetroTone;
                    if (metronomeSynth) metronomeSynth.toDestination();
                    if (membraneSynth) membraneSynth.disconnect();
                }
            }
        }
        
        function startMetronome() {
            if (Tone.context.state !== 'running') { Tone.start(); }
            if (metronomeLoop) return; 

            setMetronomeTone(metroToneSelect.value);

            let beat = 0;
            const clickInterval = "4n"; 
            
            const highlightDuration = Tone.Time("16n").toMilliseconds(); 

            metronomeLoop = new Tone.Loop(time => {
                const note = (beat % 4 === 0) ? "C5" : "C4"; 
                const velocity = (beat % 4 === 0) ? 0.9 : 0.6;
                
                if (currentMetroTone === 'membrane') {
                    if (membraneSynth) membraneSynth.triggerAttackRelease(note, "32n", time, velocity);
                } else {
                    if (metronomeSynth) metronomeSynth.triggerAttackRelease(note, "32n", time, velocity);
                }
                
                metronomeIndicator.classList.add('metronome-active');
                setTimeout(() => {
                    metronomeIndicator.classList.remove('metronome-active');
                }, highlightDuration);
                
                beat++;
            }, clickInterval).start(0);

            Tone.Transport.start();
            metroStartBtn.disabled = true;
            metroStopBtn.disabled = false;
            metroStartBtn.classList.add('opacity-50');
            metroStopBtn.classList.remove('opacity-50');
        }

        function stopMetronome() {
            if (metronomeLoop) {
                Tone.Transport.clear(metronomeLoop.id);
                metronomeLoop = null;
            }
            if (arpeggiator === null) {
                Tone.Transport.stop();
            }
            metronomeIndicator.classList.remove('metronome-active');
            metroStartBtn.disabled = false;
            metroStopBtn.disabled = true;
            metroStartBtn.classList.remove('opacity-50');
            metroStopBtn.classList.add('opacity-50');
        }


        // --- RESOURCE GENERATOR IMPLEMENTATION ---

        function renderResourceOutput(text, sources) {
            resourceContentEl.innerHTML = '';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'prose max-w-none text-gray-100';
            textDiv.innerHTML = text; 
            resourceContentEl.appendChild(textDiv);

            if (sources && sources.length > 0) {
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'mt-6 pt-4 border-t border-gray-600';
                
                const sourceTitle = document.createElement('h3');
                sourceTitle.className = 'text-lg font-semibold text-accent-yellow mb-2';
                sourceTitle.textContent = 'Sources Used:';
                sourcesContainer.appendChild(sourceTitle);
                
                const sourceList = document.createElement('ul');
                sourceList.className = 'list-disc list-inside space-y-1 text-sm text-gray-400';
                
                sources.forEach((source, index) => {
                    if (source.uri && source.title) {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = source.uri;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-primary-teal hover:text-teal-400 transition-colors underline';
                        link.textContent = source.title;
                        
                        listItem.textContent = `[${index + 1}] `;
                        listItem.appendChild(link);
                        sourceList.appendChild(listItem);
                    }
                });
                
                sourcesContainer.appendChild(sourceList);
                resourceContentEl.appendChild(sourcesContainer);
            }
            
            initialMessageEl.style.display = 'none';
            resourceContentEl.classList.remove('hidden');
        }

        async function generateResourceContent() {
            const userQuery = resourceQueryInput.value.trim();
            if (!userQuery) {
                alertUser("Please enter a question for the music resource generator.", true);
                return;
            }
            
            resourceGenerateBtn.disabled = true;
            resourceGenerateBtn.textContent = 'Generating...';
            resourceLoadingEl.style.display = 'flex';
            resourceContentEl.classList.add('hidden');
            initialMessageEl.style.display = 'none';

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await backoffFetch(API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let generatedText = "Sorry, I couldn't generate a coherent response.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }
                
                renderResourceOutput(generatedText, sources);

            } catch (error) {
                console.error("Gemini API call failed:", error);
                renderResourceOutput(`**Error generating resource:** The API request failed. Please try a different query or check your connection. Details: ${error.message}`, []);
            } finally {
                resourceGenerateBtn.disabled = false;
                resourceGenerateBtn.textContent = 'Generate Resource';
                resourceLoadingEl.style.display = 'none';
            }
        }

        // --- 5. CHORD/KEYBOARD LOGIC ---
        
        function populateInitialSelectors() {
            rootSelect.innerHTML = '';
            NOTES.forEach(note => {
                const option = document.createElement('option');
                option.value = note; 
                option.textContent = getDisplayName(note); 
                rootSelect.appendChild(option);
            });
            rootSelect.value = 'C'; 

            typeSelect.innerHTML = '';
            Object.keys(CHORD_FORMULAS).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
            typeSelect.value = 'Major'; 
            
            updateInversionOptions(); 
        }
        
        function updateRootNoteNames() {
            const currentRootValue = rootSelect.value;
            rootSelect.innerHTML = ''; 
            
            NOTES.forEach(note => {
                const option = document.createElement('option');
                option.value = note; 
                option.textContent = getDisplayName(note); 
                rootSelect.appendChild(option);
            });
            
            rootSelect.value = currentRootValue;
        }

        function updateInversionOptions() {
            const currentType = typeSelect.value;
            const formulaLength = CHORD_FORMULAS[currentType].length;
            let currentInversion = parseInt(inversionSelect.value, 10);
            
            if (isNaN(currentInversion) || currentInversion < 0 || currentInversion >= formulaLength) {
                currentInversion = 0; 
            }

            inversionSelect.innerHTML = '';
            for (let i = 0; i < formulaLength; i++) {
                const option = document.createElement('option');
                option.value = i;
                let text = i === 0 ? "Root Position" : `${i}st/nd/rd/th Inversion`; // Simplified for display
                if (i === 1) text = "1st Inversion";
                if (i === 2) text = "2nd Inversion";
                if (i === 3) text = "3rd Inversion";
                if (i > 3) text = `${i}th Inversion`;
                option.textContent = text;
                inversionSelect.appendChild(option);
            }
            inversionSelect.value = currentInversion.toString();
        }

        function drawPiano() {
            pianoContainer.innerHTML = ''; 
            
            for (let i = 0; i < NUM_OCTAVES; i++) {
                WHITE_NOTES_OCTAVE.forEach(noteName => {
                    const octave = START_OCTAVE + i;
                    
                    const whiteKey = document.createElement('div');
                    whiteKey.className = 'key white';
                    whiteKey.dataset.note = noteName;
                    whiteKey.dataset.octave = octave;
                    
                    const blackKey = document.createElement('div');
                    blackKey.className = 'key black';
                    const blackNoteIndex = (NOTES.indexOf(noteName) + 1) % 12;
                    const blackNoteName = NOTES[blackNoteIndex];
                    blackKey.dataset.note = blackNoteName;
                    blackKey.dataset.octave = octave;

                    const blackLabel = document.createElement('div');
                    blackLabel.className = 'key-label black-label';
                    blackKey.appendChild(blackLabel); 

                    whiteKey.appendChild(blackKey);

                    const whiteLabel = document.createElement('div');
                    whiteLabel.className = 'key-label white-label';
                    whiteKey.appendChild(whiteLabel); 

                    pianoContainer.appendChild(whiteKey);
                });
            }
            
            const finalCOctave = START_OCTAVE + NUM_OCTAVES;
            const finalCKey = document.createElement('div');
            finalCKey.className = 'key white';
            finalCKey.dataset.note = 'C';
            finalCKey.dataset.octave = finalCOctave;
            const finalWhiteLabel = document.createElement('div');
            finalWhiteLabel.className = 'key-label white-label';
            finalCKey.appendChild(finalWhiteLabel);
            pianoContainer.appendChild(finalCKey);
            
            document.querySelectorAll('.key').forEach(key => {
                const pressHandler = (e) => {
                    e.preventDefault(); 
                    if (Tone.context.state !== 'running') { Tone.start(); }
                    const noteName = key.dataset.note;
                    const octave = key.dataset.octave;
                    
                    if (synth) {
                       synth.triggerAttackRelease(`${noteName}${octave}`, "8n");
                    }
                    
                    key.classList.add('pressed');
                };

                const releaseHandler = (e) => {
                    e.preventDefault();
                    key.classList.remove('pressed');
                };

                key.addEventListener('mousedown', pressHandler);
                key.addEventListener('mouseup', releaseHandler);
                key.addEventListener('touchstart', pressHandler);
                key.addEventListener('touchend', releaseHandler);
                key.addEventListener('mouseleave', releaseHandler); 
            });
        }

        function getChordNotes(rootNote, formula) {
            if (!Array.isArray(formula) || formula.length === 0) { return []; }

            const rootIndex = NOTES.indexOf(rootNote);
            const baseOctave = parseInt(baseOctaveSelect.value, 10); 
            
            const notes = formula.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const octaveOffset = Math.floor((rootIndex + interval) / 12);
                return {
                    name: NOTES[noteIndex],
                    octaveOffset: octaveOffset
                };
            });

            const inversion = parseInt(inversionSelect.value, 10);
            let invertedNotes = [...notes];

            for (let i = 0; i < inversion; i++) {
                const firstNote = invertedNotes.shift();
                firstNote.octaveOffset += 1; 
                invertedNotes.push(firstNote);
            }

            const notesWithOctave = invertedNotes.map(n => ({
                name: n.name,
                octave: baseOctave + n.octaveOffset,
                displayName: getDisplayName(n.name),
                midiName: `${n.name}${baseOctave + n.octaveOffset}`
            }));
            
            return notesWithOctave;
        }
        
        function stopChord() {
            if (synth) {
                synth.releaseAll();
            }
            if (arpeggiator) {
                Tone.Transport.clear(arpeggiator.id);
                arpeggiator = null; 
                
                if (!metronomeLoop) {
                    Tone.Transport.stop(); 
                }
            }
            playBtn.textContent = 'Play Chord';
            playBtn.disabled = false;
            playBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
            playBtn.classList.add('bg-secondary-pink', 'hover:bg-pink-600');
        }

        function playChord() {
            if (!synth) { return; }
            
            stopChord(); 
            
            if (Tone.context.state !== 'running') { Tone.start(); }
            
            const notesData = getChordNotes(rootSelect.value, CHORD_FORMULAS[typeSelect.value]);
            const notesToPlay = notesData.map(n => n.midiName);

            if (notesToPlay.length === 0) return;

            const mode = playModeSelect.value;
            playBtn.textContent = 'Playing...';
            playBtn.disabled = true;
            playBtn.classList.remove('bg-secondary-pink', 'hover:bg-pink-600');
            playBtn.classList.add('bg-gray-500', 'cursor-not-allowed');


            if (mode === 'simultaneous') {
                synth.triggerAttack(notesToPlay);
                
                Tone.Transport.scheduleOnce(() => {
                    stopChord();
                }, Tone.now() + 2.0);
                
            } else if (mode === 'arpeggiated') {
                arpeggiator = new Tone.Sequence((time, note) => {
                    synth.triggerAttackRelease(note, "8n", time);
                }, notesToPlay, "8n").start(0);

                if (!metronomeLoop) {
                    Tone.Transport.loop = true;
                    Tone.Transport.loopStart = 0;
                    const sequenceDuration = notesToPlay.length * Tone.Time("8n").toSeconds();
                    Tone.Transport.loopEnd = sequenceDuration;
                
                    Tone.Transport.start();
                } else {
                    Tone.Transport.start();
                }
            }
        }

        function updateKeyLabels() {
            document.querySelectorAll('.key').forEach(key => {
                const octave = key.dataset.octave;
                const noteName = key.dataset.note;
                const isBlackKey = key.classList.contains('black');
                
                const labelEl = isBlackKey 
                    ? key.querySelector('.black-label') 
                    : key.querySelector('.white-label');

                if (labelEl) {
                    labelEl.textContent = `${getDisplayName(noteName)}${octave}`;
                }
            });
        }

        function highlightPiano(notesData) {
            document.querySelectorAll('.key.highlighted').forEach(key => {
                key.classList.remove('highlighted');
            });

            notesData.forEach(note => {
                const selector = `.key[data-note="${note.name}"][data-octave="${note.octave}"]`;
                document.querySelectorAll(selector).forEach(key => {
                    key.classList.add('highlighted');
                });
            });
        }
        
        function updateChordInfo(notesData) {
            const rootNote = rootSelect.value;
            const chordType = typeSelect.value;
            const inversion = inversionSelect.value;

            const inversionText = ["Root Position", "1st Inversion", "2nd Inversion", "3rd Inversion", "4th Inversion", "5th Inversion"][inversion] || "Inversion Error";

            chordNameEl.textContent = `${getDisplayName(rootNote)} ${chordType} (${inversionText})`;
            chordNotesEl.textContent = notesData.map(n => `${n.displayName}${n.octave}`).join(' - ');
        }
        
        function refreshChordDisplay() {
            stopChord(); 
            updateKeyLabels();
            const rootNote = rootSelect.value;
            const chordType = typeSelect.value;
            const formula = CHORD_FORMULAS[chordType];
            const notesData = getChordNotes(rootNote, formula);
            updateChordInfo(notesData);
            highlightPiano(notesData);
        }

        
        function renderSongsView() {
            songsListEl.innerHTML = '';
            
            SIMPLE_SONGS.forEach(song => {
                const chordChipsHtml = song.progression.map(fullChord => {
                    const parts = fullChord.split(' ');
                    const rootNote = parts[0];
                    const chordType = parts.length > 1 ? parts.slice(1).join(' ') : 'Major'; 
                    
                    return `<span class="chord-chip bg-primary-teal/20 text-primary-teal px-3 py-1 rounded-full text-sm font-semibold cursor-pointer hover:bg-primary-teal/40 transition-colors mr-2 mb-2 inline-block" data-root="${rootNote}" data-type="${chordType}">${fullChord}</span>`;
                }).join('');

                const songCard = document.createElement('div');
                songCard.className = 'bg-gray-700 p-5 rounded-xl shadow-lg border-l-4 border-secondary-pink';
                songCard.innerHTML = `
                    <h3 class="text-2xl font-bold text-white mb-1">${song.title} <span class="text-sm font-normal text-gray-400">by ${song.artist}</span></h3>
                    <p class="text-sm text-gray-400 mb-3">Key: <span class="text-accent-yellow font-semibold">${song.key}</span></p>
                    <div class="flex flex-wrap items-center">
                        <span class="text-gray-300 font-medium mr-2">Progression:</span>
                        ${chordChipsHtml}
                    </div>
                `;
                songsListEl.appendChild(songCard);
            });
            
            document.querySelectorAll('.chord-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    const rootNote = e.target.dataset.root;
                    const chordType = e.target.dataset.type;
                    
                    setChordSelectors(rootNote, chordType);
                    
                    viewSelector.value = 'chord-view';
                    switchView('chord-view');
                    refreshChordDisplay(); 
                });
            });
        }
        
        function setChordSelectors(root, type) {
            const isFlatRoot = Object.keys(FLAT_TO_SHARP).includes(root);
            
            if (isFlatRoot) {
                if (useSharps) flatsBtn.click();
                rootSelect.value = FLAT_TO_SHARP[root];
            } else if (root.includes('#')) {
                if (!useSharps) sharpsBtn.click();
                rootSelect.value = root;
            } else {
                if (!useSharps) sharpsBtn.click();
                rootSelect.value = root;
            }
            
            const typeKey = Object.keys(CHORD_FORMULAS).find(key => key.toLowerCase() === type.toLowerCase());
            if (typeKey) {
                typeSelect.value = typeKey;
                updateInversionOptions(); 
            } else {
                typeSelect.value = 'Major';
                updateInversionOptions(); 
            }
            
            inversionSelect.value = '0';
        }


        // --- 9. FIREBASE AUTHENTICATION & GATING SETUP ---
        
        function initFirebaseEnvironment() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 

                setPersistence(auth, browserSessionPersistence)
                    .catch((error) => {
                        console.error("Failed to set auth persistence:", error);
                    });
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userStatusEl.innerHTML = `Signed in as <span class="font-bold text-primary-teal">${userId}</span>`;
                        signOutBtn.style.display = 'flex';
                    } else {
                        userId = null;
                        userStatusEl.textContent = "Status: Signed out";
                        signOutBtn.style.display = 'none';

                        // If the user was using the app and signs out, return to the gate
                        if (!authenticatedContentEl.classList.contains('hidden')) {
                             authenticatedContentEl.classList.add('hidden');
                             appLoadingEl.style.display = 'none';
                             accessGateEl.style.display = 'flex';
                             alertUser("You have been signed out. Please re-enter the key.", false);
                        }
                    }
                });

                signOutBtn.addEventListener('click', () => {
                    if (auth.currentUser) {
                        signOut(auth).catch(e => console.error("Sign out failed:", e));
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                accessMessageEl.textContent = "Error: Firebase failed to initialize.";
                unlockBtn.disabled = true;
            }
        }

        function initApp() {
            // This function runs once the key is validated AND the user is successfully authenticated.
            
            // 1. Hide gate/loading, show content
            accessGateEl.style.display = 'none';
            appLoadingEl.style.display = 'none';
            authenticatedContentEl.classList.remove('hidden');
            
            // 2. Complete core app init tasks
            initTone();
            populateInitialSelectors();
            drawPiano();
            renderSongsView();
            stopMetronome(); 
        }
        
        async function handleAccessGate() {
            const enteredKey = accessKeyInput.value.trim();
            
            if (enteredKey === SECRET_ACCESS_KEY) {
                accessMessageEl.textContent = "";
                accessGateEl.style.display = 'none';
                appLoadingEl.style.display = 'flex'; 
                unlockBtn.disabled = true; 
                accessKeyInput.value = ''; // Clear key immediately

                // Define a timeout promise (10 seconds)
                const timeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error("Authentication timed out after 10 seconds.")), 10000);
                });

                // Authentication Promise
                const authPromise = (async () => {
                    let userCredential;
                    if (initialAuthToken) {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        userCredential = await signInAnonymously(auth);
                    }
                    if (userCredential && userCredential.user) {
                        return userCredential;
                    } else {
                        throw new Error("Authentication failed: User object missing.");
                    }
                })();
                
                try {
                    // Race the authentication against the timeout
                    await Promise.race([authPromise, timeout]);
                    
                    // If we reach here, authentication succeeded before timeout
                    initApp();

                } catch (error) {
                    // --- CRITICAL UI RESET BLOCK (Guaranteed to run on failure/timeout) ---
                    console.error("CRITICAL AUTHENTICATION FAILURE (Please report this error message):", error.message);
                    
                    // 1. Show access gate, hide loading screen
                    appLoadingEl.style.display = 'none';
                    accessGateEl.style.display = 'flex';
                    
                    // 2. Set user facing error message
                    let message = "Authentication failed: Please check your connection or try again.";
                    if (error.message.includes("timed out")) {
                        message = "Connection timeout (10s limit exceeded). The service is unreachable. Please try again.";
                    }
                    alertUser(message, true);
                    
                } finally {
                    // 3. UNCONDITIONALLY re-enable the button
                    unlockBtn.disabled = false;
                }
                
            } else {
                accessKeyInput.value = '';
                alertUser("Incorrect key. Try again.", true);
            }
        }


        // --- 10. INITIALIZATION AND LISTENERS ---
        
        function initAppListeners() {
            // Access Gate Listener
            unlockBtn.addEventListener('click', handleAccessGate);
            accessKeyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { handleAccessGate(); }
            });

            // Navigation
            viewSelector.addEventListener('change', (e) => switchView(e.target.value));

            // Chord Event Listeners (Rest of the listeners...)
            rootSelect.addEventListener('change', refreshChordDisplay);
            baseOctaveSelect.addEventListener('change', refreshChordDisplay);
            inversionSelect.addEventListener('change', refreshChordDisplay);
            playModeSelect.addEventListener('change', refreshChordDisplay);
            
            typeSelect.addEventListener('change', () => {
                updateInversionOptions();
                refreshChordDisplay();
            });
            
            // Sharps/Flats Toggles
            sharpsBtn.addEventListener('click', () => {
                useSharps = true;
                sharpsBtn.classList.add('bg-primary-teal', 'text-gray-900');
                sharpsBtn.classList.remove('hover:bg-primary-teal/50', 'text-white');
                flatsBtn.classList.remove('bg-primary-teal', 'text-gray-900');
                flatsBtn.classList.add('hover:bg-primary-teal/50', 'text-white');
                updateRootNoteNames();
                refreshChordDisplay();
            });
            
            flatsBtn.addEventListener('click', () => {
                useSharps = false;
                flatsBtn.classList.add('bg-primary-teal', 'text-gray-900');
                flatsBtn.classList.remove('hover:bg-primary-teal/50', 'text-white');
                sharpsBtn.classList.remove('bg-primary-teal', 'text-gray-900');
                sharpsBtn.classList.add('hover:bg-primary-teal/50', 'text-white');
                updateRootNoteNames();
                refreshChordDisplay();
            });
            
            // Play/Stop/Download
            playBtn.addEventListener('click', playChord);
            stopBtn.addEventListener('click', stopChord);
            
            downloadBtn.addEventListener('click', () => {
                const element = document.getElementById('piano-keyboard');
                const name = element.dataset.name || 'piano-diagram';
                
                // Get the current dimensions of the content inside the scrollable container
                const contentWidth = element.scrollWidth;
                const contentHeight = element.scrollHeight;

                html2canvas(element, { 
                    width: contentWidth, 
                    height: contentHeight,
                    backgroundColor: '#1f2937', 
                    scale: 2 // Use a higher scale for better resolution
                }).then(canvas => {
                    const dataUrl = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = `${name}-${chordNameEl.textContent.replace(/\s/g, '-')}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }).catch(err => {
                    console.error("Error generating canvas:", err);
                });
            });


            // Metronome Event Listeners
            metroStartBtn.addEventListener('click', startMetronome);
            metroStopBtn.addEventListener('click', stopMetronome);
            
            bpmInput.addEventListener('input', (e) => updateBPM(e.target.value));
            bpmSlider.addEventListener('input', (e) => updateBPM(e.target.value));
            
            metroToneSelect.addEventListener('change', (e) => {
                setMetronomeTone(e.target.value);
            });
            
            // Resource Generator Listener
            resourceGenerateBtn.addEventListener('click', generateResourceContent);

        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initFirebaseEnvironment(); 
            initAppListeners(); 
            accessGateEl.style.display = 'flex'; // Ensure initial state is the gate
        });
    </script>
</body>
</html>
